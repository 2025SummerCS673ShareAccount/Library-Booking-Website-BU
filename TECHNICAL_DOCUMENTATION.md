# BU Library Booking System - Technical Data Structure Documentation

## üìã Project Overview

This document provides comprehensive technical specifications for the data structures and field definitions used across the three subprojects of the BU Library Booking System:
- **bu-book**: React TypeScript frontend application
- **bub-backend**: Python Flask API server
- **admin-page**: React administration dashboard

## üèóÔ∏è Core Data Structures

### 1. Building Interface

**Source**: `bu-book/src/types/building.ts`

```typescript
export interface Building {
  id: number;                    // Unique building identifier
  Name: string;                  // Full building name
  ShortName: string;             // Building abbreviation (mug, par, pic, sci)
  Address: string;               // Building physical address
  website: string;               // Building official website
  contacts: Record<string, string>; // Contact information (JSON object)
  available: boolean;            // Whether building has available rooms
  libcal_id: number;            // LibCal system identifier
  lid: number;                   // LibCal Location ID
  Rooms?: Room[];               // Associated rooms array
}
```

**Field Details**:
- `ShortName`: Maps to bub-backend LIBRARY_LIDS keys
- `lid`: Core parameter for LibCal API calls
- `available`: Calculated based on real-time room availability
- `Rooms`: Foreign key relationship containing all rooms in this building

### 2. Room Interface

**Source**: `bu-book/src/types/building.ts`

```typescript
export interface Room {
  id: number;                    // Unique room database identifier
  building_id: number;           // Foreign key to Building.id
  eid: number;                   // LibCal Equipment ID (room identifier in LibCal)
  title: string;                 // Room display name
  url: string;                   // LibCal booking URL
  grouping: string;              // Room grouping information
  capacity: number;              // Room capacity
  gtype: number;                 // LibCal group type
  gBookingSelectableTime: boolean; // Whether time selection is allowed
  hasInfo: boolean;              // Whether detailed information is available
  thumbnail: string;             // Room thumbnail image URL
  filterIds: number[];           // LibCal filter ID array
  available: boolean;            // Current availability status
}
```

**Field Details**:
- `eid`: Core field for room identification in LibCal API
- `building_id`: Foreign key relationship to Buildings table
- `available`: Calculated based on real-time LibCal data
- `gtype`: LibCal room type classification

### 3. Availability/Slot Interface

**Source**: `bu-book/src/types/availability.ts`

```typescript
export interface Availability {
  slots: Slot[];                 // Available time slots array
  bookings: Slot[];             // Booked time slots array
  isPreCreatedBooking: boolean; // Whether pre-created booking exists
  windowEnd: boolean;           // Whether booking window has ended
}

export interface Slot {
  itemId: number;               // Corresponds to Room.eid
  start: Date;                  // Start time
  end: Date;                    // End time
  checksum: string;             // LibCal checksum
  className: string;            // CSS class name (status identifier)
}
```

**Field Details**:
- `itemId`: One-to-one correspondence with Room.eid
- `className`: Room status identifier (e.g., 's-lc-eq-period-booked')
- `checksum`: Unique identifier generated by LibCal

## üîó bub-backend API Specifications

### LIBRARY_LIDS Mapping Table

**Source**: `bub-backend/main.py`

```python
LIBRARY_LIDS = {
    "mug": 19336,    # Mugar Memorial Library
    "par": 19818,    # Pardee Library  
    "pic": 18359,    # Pickering Educational Resources Library
    "sci": 20177     # Science & Engineering Library
}
```

### API Endpoint: `/api/availability`

**Request Format**:
```json
{
  "library": "par",           // Building.ShortName
  "start": "2025-07-25",      // Start date (YYYY-MM-DD)
  "end": "2025-07-25",        // End date (YYYY-MM-DD)
  "start_time": "13:00",      // Optional: Filter start time (HH:MM)
  "end_time": "16:00"         // Optional: Filter end time (HH:MM)
}
```

**Response Format**:
```json
{
  "bookings": [],
  "isPreCreatedBooking": false,
  "slots": [
    {
      "checksum": "765760965e8740b8700df9932933cb88",
      "end": "2025-07-25 13:30:00",
      "itemId": 168796,
      "start": "2025-07-25 13:00:00",
      "className": "s-lc-eq-period-booked"
    }
  ]
}
```

## üìä admin-page Data Mapping

### BookingsPage Data Structure

Unified data model based on LibCal API and bu-book interfaces:

```javascript
const bookingRecord = {
  // Unique identifiers
  id: `${building.lid}-${booking.itemId}-${date}-${index}`,
  checksum: booking.checksum,

  // Room information (from Room interface)
  roomId: room.id,
  roomTitle: room.title,
  roomEid: booking.itemId,      // = Room.eid
  roomCapacity: room.capacity,

  // Building information (from Building interface)
  buildingId: building.id,
  buildingName: building.Name,
  buildingShortName: building.ShortName,
  buildingLid: building.lid,

  // Time information (from Slot interface)
  date: date,
  startTime: dayjs(booking.start).format('HH:mm'),
  endTime: dayjs(booking.end).format('HH:mm'),
  startDateTime: booking.start,
  endDateTime: booking.end,
  duration: dayjs(booking.end).diff(dayjs(booking.start), 'hour', true),

  // Status information
  status: 'confirmed|active|completed|pending',
  isActive: boolean,
  isPast: boolean,
  isFuture: boolean,
  className: booking.className,

  // Generated user information (LibCal doesn't expose user data)
  userName: string,
  userType: 'Student|Faculty|Staff|Graduate Student'
};
```

### LocationsPage Data Structure

Fully based on bu-book Building and Room interfaces:

```javascript
// Buildings table columns
const buildingColumns = [
  { dataIndex: 'Name', title: 'Building Name' },
  { dataIndex: 'ShortName', title: 'Short Name' },
  { dataIndex: 'Address', title: 'Address' },
  { dataIndex: 'lid', title: 'LibCal LID' },
  { dataIndex: 'available', title: 'Available' }
];

// Rooms table columns
const roomColumns = [
  { dataIndex: 'title', title: 'Room Name' },
  { dataIndex: 'eid', title: 'EID' },
  { dataIndex: 'capacity', title: 'Capacity' },
  { dataIndex: 'gtype', title: 'Type' },
  { dataIndex: 'available', title: 'Available' }
];
```

### DashboardPage Statistics Data

Integrated data sources from all three systems:

```javascript
const statisticsData = {
  // From Supabase Buildings/Rooms tables
  totalBuildings: number,
  totalRooms: number,
  
  // From bub-backend LibCal API
  totalSlots: number,
  availableSlots: number,
  totalBookings: number,
  
  // Calculated fields
  utilizationRate: number,
  buildingAvailabilityRate: number,
  roomAvailabilityRate: number
};
```

## üóÑÔ∏è Database Schema (Supabase)

### Buildings Table

```sql
CREATE TABLE Buildings (
  id SERIAL PRIMARY KEY,
  Name VARCHAR(255) NOT NULL,
  ShortName VARCHAR(10) NOT NULL UNIQUE,
  Address TEXT,
  website VARCHAR(255),
  contacts JSONB,
  available BOOLEAN DEFAULT true,
  libcal_id INTEGER,
  lid INTEGER NOT NULL UNIQUE
);
```

### Rooms Table

```sql
CREATE TABLE Rooms (
  id SERIAL PRIMARY KEY,
  building_id INTEGER REFERENCES Buildings(id),
  eid INTEGER NOT NULL UNIQUE,
  title VARCHAR(255) NOT NULL,
  url VARCHAR(255),
  grouping VARCHAR(100),
  capacity INTEGER DEFAULT 6,
  gtype INTEGER,
  gBookingSelectableTime BOOLEAN DEFAULT true,
  hasInfo BOOLEAN DEFAULT false,
  thumbnail VARCHAR(255),
  filterIds INTEGER[],
  available BOOLEAN DEFAULT true
);
```

### Foreign Key Relationships

```sql
-- Room to Building relationship
ALTER TABLE Rooms 
ADD CONSTRAINT fk_room_building 
FOREIGN KEY (building_id) REFERENCES Buildings(id);

-- Index for performance
CREATE INDEX idx_rooms_building_id ON Rooms(building_id);
CREATE INDEX idx_rooms_eid ON Rooms(eid);
CREATE INDEX idx_buildings_lid ON Buildings(lid);
CREATE INDEX idx_buildings_shortname ON Buildings(ShortName);
```

## üîÑ Data Flow Architecture

### 1. Data Retrieval Flow

```
LibCal API ‚Üí bub-backend ‚Üí admin-page/bu-book
     ‚Üì
Supabase Buildings/Rooms ‚Üê admin-page CRUD operations
```

### 2. Availability Check Flow

```
1. bu-book fetches Buildings (including Rooms)
2. Calls bub-backend /api/availability endpoint
3. Matches Room.eid with Slot.itemId
4. Calculates Room.available status
5. Aggregates Building.available status
```

### 3. Booking Data Flow

```
1. LibCal system (actual bookings)
2. bub-backend proxies API to get bookings
3. admin-page displays booking records
4. Matches Room/Building information
```

## üè∑Ô∏è Status Classification System

### Room Availability Status

Based on LibCal className field:

```javascript
const UNAVAILABLE_CLASSES = new Set([
  's-lc-eq-checkout',           // Checked out
  's-lc-eq-r-unavailable',     // Unavailable
  's-lc-eq-r-padding',         // Padding time
  'label-eq-unavailable',      // Marked unavailable
  's-lc-eq-period-booked'      // Booked
]);

// Availability calculation
const isAvailable = !className || !UNAVAILABLE_CLASSES.has(className);
```

### Booking Status Classification

```javascript
const statusConfig = {
  confirmed: { color: 'blue', text: 'Confirmed' },    // Confirmed booking
  active: { color: 'green', text: 'Active' },         // Currently in progress
  completed: { color: 'default', text: 'Completed' }, // Completed booking
  pending: { color: 'orange', text: 'Pending' }       // Pending confirmation
};

// Status determination logic
const determineBookingStatus = (booking) => {
  const now = dayjs();
  const bookingStart = dayjs(booking.start);
  const bookingEnd = dayjs(booking.end);
  
  if (now.isAfter(bookingEnd)) return 'completed';
  if (now.isBetween(bookingStart, bookingEnd)) return 'active';
  if (now.isBefore(bookingStart)) return 'confirmed';
  return 'pending';
};
```

## üîß Development Guidelines

### Adding New Buildings

1. **Supabase**: Insert new record in Buildings table
2. **bub-backend**: Add mapping to LIBRARY_LIDS
3. **bu-book**: Data syncs automatically
4. **admin-page**: Recognizes new building automatically

```sql
-- Example: Adding new building
INSERT INTO Buildings (Name, ShortName, Address, lid) 
VALUES ('New Library', 'new', '123 Main St', 12345);
```

```python
# Update bub-backend mapping
LIBRARY_LIDS = {
    "mug": 19336,
    "par": 19818,
    "pic": 18359,
    "sci": 20177,
    "new": 12345     # Add new mapping
}
```

### Adding New Rooms

1. **Obtain LibCal room data** (via LibCal API)
2. **Use RoomGenerator component** for batch import
3. **Verify Room.eid** matches LibCal itemId
4. **Test availability checking** functionality

```javascript
// Room import example
const roomData = {
  building_id: 1,
  eid: 168796,
  title: "Study Room A",
  capacity: 6,
  gtype: 1
};
```

### Field Modification Considerations

‚ö†Ô∏è **Warning**: The following field modifications require synchronization across multiple systems:

- `Building.ShortName` ‚Üî `LIBRARY_LIDS` keys
- `Building.lid` ‚Üî `LIBRARY_LIDS` values  
- `Room.eid` ‚Üî LibCal `itemId`
- `Slot.itemId` ‚Üî `Room.eid`

## üìà Performance Optimization

### 1. Caching Strategy

```javascript
// Recommended cache durations
const CACHE_DURATIONS = {
  buildings: 24 * 60 * 60 * 1000,    // 24 hours
  rooms: 24 * 60 * 60 * 1000,       // 24 hours
  availability: 5 * 60 * 1000,       // 5 minutes
  bookings: 0                        // Real-time (no cache)
};
```

### 2. API Call Optimization

```javascript
// Batch API calls
const fetchMultipleDates = async (library, dates) => {
  const promises = dates.map(date =>
    fetch('/api/availability', {
      method: 'POST',
      body: JSON.stringify({ library, start: date, end: date })
    })
  );
  
  return Promise.allSettled(promises);
};

// Parallel building requests
const fetchAllBuildings = async (buildings, date) => {
  const promises = buildings.map(building =>
    fetchAvailability(building.ShortName, date)
  );
  
  return Promise.allSettled(promises);
};
```

### 3. Frontend Optimization

```javascript
// Virtual scrolling for large datasets
import { FixedSizeList as List } from 'react-window';

// Lazy loading room details
const LazyRoomDetails = React.lazy(() => import('./RoomDetails'));

// Local state management
const useBookingsState = () => {
  const [bookings, setBookings] = useState([]);
  const [filteredBookings, setFilteredBookings] = useState([]);
  
  const filterBookings = useCallback((filters) => {
    // Optimized filtering logic
  }, [bookings]);
  
  return { bookings, filteredBookings, filterBookings };
};
```

## üêõ Troubleshooting Guide

### LibCal API Issues

```javascript
// Timeout handling
const fetchWithTimeout = async (url, options, timeout = 5000) => {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), timeout);
  
  try {
    const response = await fetch(url, {
      ...options,
      signal: controller.signal
    });
    clearTimeout(timeoutId);
    return response;
  } catch (error) {
    clearTimeout(timeoutId);
    if (error.name === 'AbortError') {
      throw new Error('Request timeout');
    }
    throw error;
  }
};

// Retry mechanism
const fetchWithRetry = async (url, options, maxRetries = 3) => {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fetchWithTimeout(url, options);
    } catch (error) {
      if (i === maxRetries - 1) throw error;
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
};
```

### Data Validation

```javascript
// Room.eid validation
const validateRoomEid = (rooms, slots) => {
  const missingRooms = slots.filter(slot => 
    !rooms.find(room => room.eid === slot.itemId)
  );
  
  if (missingRooms.length > 0) {
    console.warn('Missing rooms for itemIds:', 
      missingRooms.map(s => s.itemId)
    );
  }
  
  return missingRooms;
};

// Building LID validation
const validateBuildingLids = (buildings) => {
  return buildings.filter(building => 
    LIBRARY_LIDS[building.ShortName] !== building.lid
  );
};
```

### Timezone Handling

```javascript
// Consistent timezone handling
import dayjs from 'dayjs';
import utc from 'dayjs/plugin/utc';
import timezone from 'dayjs/plugin/timezone';

dayjs.extend(utc);
dayjs.extend(timezone);

// Convert LibCal times to local timezone
const parseLibCalTime = (timeString) => {
  return dayjs.utc(timeString).local();
};

// Format for display
const formatDisplayTime = (date) => {
  return dayjs(date).format('YYYY-MM-DD HH:mm');
};
```

## üìù Maintenance Checklist

### Weekly Monitoring
- [ ] LibCal API connection status
- [ ] bub-backend service health
- [ ] Supabase database connectivity
- [ ] Error rate monitoring

### Monthly Reviews  
- [ ] New/changed building information
- [ ] Room data updates
- [ ] API performance metrics
- [ ] Cache hit rates

### Semester Start Tasks
- [ ] LibCal system configuration changes
- [ ] New library/room additions
- [ ] User permission updates
- [ ] Data integrity validation

### Code Quality Checks
- [ ] TypeScript type definitions up-to-date
- [ ] Database schema migrations
- [ ] API endpoint documentation
- [ ] Error handling coverage

## üîí Security Considerations

### API Security

```javascript
// Input validation
const validateLibraryCode = (library) => {
  const validCodes = Object.keys(LIBRARY_LIDS);
  return validCodes.includes(library);
};

// Date validation
const validateDateRange = (start, end) => {
  const startDate = dayjs(start);
  const endDate = dayjs(end);
  const maxRange = 30; // days
  
  return startDate.isValid() && 
         endDate.isValid() && 
         endDate.diff(startDate, 'day') <= maxRange;
};
```

### Database Security

```sql
-- Row Level Security policies
CREATE POLICY "Buildings are viewable by authenticated users" ON Buildings
  FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Rooms are viewable by authenticated users" ON Rooms
  FOR SELECT USING (auth.role() = 'authenticated');
```

## üìñ API Documentation

### bub-backend Endpoints

#### POST `/api/availability`
Retrieves room availability and booking data from LibCal.

**Parameters**:
- `library` (string, required): Building short name
- `start` (string, required): Start date (YYYY-MM-DD)
- `end` (string, required): End date (YYYY-MM-DD)
- `start_time` (string, optional): Filter start time (HH:MM)
- `end_time` (string, optional): Filter end time (HH:MM)

**Response**:
```json
{
  "slots": [
    {
      "itemId": 168796,
      "start": "2025-07-25 13:00:00",
      "end": "2025-07-25 13:30:00",
      "checksum": "765760965e8740b8700df9932933cb88",
      "className": "s-lc-eq-period-available"
    }
  ],
  "bookings": [
    {
      "itemId": 168797,
      "start": "2025-07-25 14:00:00",
      "end": "2025-07-25 15:00:00",
      "checksum": "af932e69f44341b0a109c979087b82f6",
      "className": "s-lc-eq-period-booked"
    }
  ],
  "isPreCreatedBooking": false,
  "windowEnd": false
}
```

**Error Responses**:
- `400 Bad Request`: Invalid library code or date format
- `500 Internal Server Error`: LibCal API error
- `503 Service Unavailable`: LibCal API timeout

---

**Documentation Version**: v2.0  
**Last Updated**: 2025-07-27  
**Maintainer**: GitHub Copilot  
**Systems**: bu-book v1.0, bub-backend v1.0, admin-page v1.0  
**LibCal API Version**: 1.1
